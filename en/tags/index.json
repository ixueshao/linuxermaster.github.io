[{"content":"Harboræ˜¯ä¸€ä¸ªå¼€æºçš„ç®¡ç† Docker é•œåƒä»¥åŠ helm å›¾è¡¨çš„é¡¹ç›®ï¼Œè¯¥é¡¹ç›®åŒ…æ‹¬äº†æƒé™ç®¡ç†ã€LDAP è®¤è¯é›†æˆã€æ—¥å¿—äº‹ä»¶å®¡è®¡ã€ç®¡ç†ç•Œé¢ portalã€å¤š Harbor å®ä¾‹ä¹‹é—´æ•°æ®åŒæ­¥çš„å…¬å¸ƒåŠŸèƒ½ï¼ŒåŒæ—¶ä»Šå¹´ Harbor ä¹Ÿä» CNCF ä¸­æ¯•ä¸šäº†ï¼Œæä¾›äº†æ›´åˆè§„ã€æ€§èƒ½æ›´å¥½ã€æ“ä½œä½“éªŒæ›´ä½³çš„ 2.0 ç‰ˆæœ¬ï¼Œå¸®åŠ©æ‚¨åœ¨è·¨ kubernetes å’Œ Docker ç­‰äº‘åŸç”Ÿè®¡ç®—å¹³å°æŒç»­é«˜æ•ˆçš„ç®¡ç†åˆ¶å“ã€‚\nHarbor ç¯å¢ƒéœ€æ±‚    Software Version Description     Docker engine 17.06.0-ce åŠä»¥ä¸Š å®‰è£…å‚è€ƒ: Docker Docs   Docker Compose 1.18.0 ç‰ˆæœ¬åŠä»¥ä¸Šå³å¯ å®‰è£…å‚è€ƒ: Docker-Compose Docs   Openssl ä¸ºé¿å…å®‰å…¨æ¼æ´ï¼Œå»ºè®®å‡çº§åˆ°æœ€æ–° å¯ä»¥é€‰æ‹©è‡ªç­¾è¯ä¹¦: Config HTTPSä¹Ÿå¯ä»¥ç”³è¯·ä¸ªäººå…è´¹ç‰ˆè¯ä¹¦    Harbor ç¦»çº¿å®‰è£… è€ƒè™‘åˆ°ç½‘ç»œå’Œæµ‹è¯•çš„éœ€æ±‚ï¼Œæˆ‘ä»¬é€šè¿‡è¿…é›·åœ¨ GITHUB ä¸Šä¸‹è½½ç¦»çº¿å®‰è£…çš„ harbor å®‰è£…åŒ…ï¼Œå…¶ä¸­åŒ…å«äº† Harbor æ‰€éœ€è¦çš„åŸºç¡€é•œåƒï¼Œç¦»çº¿å®‰è£…æ—¶é€šè¿‡ç¦»çº¿å®‰è£…åŒ…å†…çš„è„šæœ¬å°†å¯¼å‡ºçš„é•œåƒæ–‡ä»¶é€šè¿‡docker load -iå¯¼å…¥åˆ°æœåŠ¡å™¨å†…ï¼Œç„¶åé€šè¿‡ç¼–æ’è½¯ä»¶docker-composeè¿è¡Œï¼Œç›¸å½“æ–¹ä¾¿ã€‚ä½¿ç”¨åˆ°çš„åŸºç¡€é•œåƒå¦‚ä¸‹:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  goharbor/chartmuseum-photon v2.0.0 4db8d6aa63e9 8 weeks ago 127MB goharbor/redis-photon v2.0.0 c89ea2e53cc0 8 weeks ago 72.2MB goharbor/trivy-adapter-photon v2.0.0 6122c52b7e48 8 weeks ago 103MB goharbor/clair-adapter-photon v2.0.0 dd2210cb7f53 8 weeks ago 62MB goharbor/clair-photon 2 v2.0.0 f7c7fcc52278 8 weeks ago 171MB goharbor/notary-server-photon v2.0.0 983ac10ed8be 8 weeks ago 143MB goharbor/notary-signer-photon v2.0.0 bee1b6d75e0d 8 weeks ago 140MB goharbor/harbor-registryctl v2.0.0 c53c32d58d04 8 weeks ago 102MB goharbor/registry-photon v2.0.0 afdc1b7ada36 8 weeks ago 84.5MB goharbor/nginx-photon v2.0.0 17892f03e56c 8 weeks ago 43.6MB goharbor/harbor-log v2.0.0 5f8ff08e795c 8 weeks ago 82MB goharbor/harbor-jobservice v2.0.0 c68a2495bf55 8 weeks ago 116MB goharbor/harbor-core v2.0.0 3aa3af64baf8 8 weeks ago 138MB goharbor/harbor-portal v2.0.0 e0b1d3c894c4 8 weeks ago 52.4MB goharbor/harbor-db v2.0.0 5c76f0296cec 8 weeks ago 154MB goharbor/prepare v2.0.0 7266d49995ed 8 weeks ago 158MB   åœ¨å®‰è£…ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸€ä¸‹ Harbor çš„é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚ä¿®æ”¹ harbor ä½¿ç”¨çš„åŸŸåã€HTTPS è¯ä¹¦çš„ä½ç½®ç­‰,ä¸‹é¢æˆ‘ä»¬ç®€å•çš„è¯´æ˜:\n1 2 3 4  â˜¸ï¸ k8sdevğŸ”¥ default ~/Downloads î‚° ğŸ³ ğŸ‘‰ scp harbor-offline-installer-v2.0.0.tgz root@192.168.99.128:/root/ # åœ¨192.168.99.128ä¸Šè¿›è¡ŒHarborçš„å®‰è£…é…ç½® root@master:~# tar xf harbor-offline-installer-v2.0.0.tgz root@master:~/harbor# mv harbor.yml.tmpl harbor.yml   æˆ‘ä»¬é‡æ–°å‘½åé…ç½®æ–‡ä»¶ harbor.yml åï¼Œç¼–è¾‘è¯¥æ–‡ä»¶\n1  hostname: harbor.devopsman.cn # é…ç½®è‡ªå·±çš„harborè®¿é—®åŸŸå   å¦‚æœä½ éœ€è¦é…ç½® HTTPS æ¥è®¿é—® harbor,é‚£ä¹ˆéœ€è¦ç”³è¯·è¯ä¹¦æˆ–è€…è‡ªå·±ç”Ÿæˆçš„è‡ªç­¾è¯ä¹¦ï¼Œè¿™é‡Œæˆ‘ä»¬ç›´æ¥åœ¨ DNSPOD ä¸Šç”³è¯·ä¸€ä¸ªå…è´¹çš„ä¸€å¹´å¯ç”¨çš„è¯ä¹¦\nå®é™…ä¸Š https çš„è¯ä¹¦æ˜¯é…ç½®ç»™ harbor çš„åå‘ä»£ç† nginx çš„ï¼Œæˆ‘ä»¬ä¸€èˆ¬è®¿é—® harbor å…¶å®æ˜¯è®¿é—® nginx ç„¶åå°†è¯·æ±‚è½¬å‘ç»™ harborï¼Œåœ¨æˆ‘ä»¬å®‰è£…å®Œæˆ harbor ä¹‹åï¼Œå¯ä»¥è¿è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹åˆ° Nginx ç›¸å…³çš„åå‘ä»£ç†çš„é…ç½®:\n1  root@master:~/harbor# docker exec -it nginx cat /etc/nginx/nginx.conf   æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦é…ç½®ä¸€ä¸‹ HTTPS å¯ä¿¡è¯ä¹¦ï¼Œé¦–å…ˆåœ¨ DNSPOD ä¸Šä¸‹è½½ç”³è¯·å®¡æ‰¹æˆåŠŸåçš„è¯ä¹¦\nç„¶åè§£å‹ï¼Œå°†è§£å‹åçš„ Nginx ç›®å½•ä¸‹çš„ä¸¤ä¸ªæ–‡ä»¶é‡å‘½åæ”¾åœ¨/data/cert/ç›®å½•ä¸‹\n1 2 3 4 5 6 7 8 9 10  root@master:~/harbor/Nginx# ls -alh total 32K drwxr-xr-x 2 root root 4.0K Jul 7 2020 . drwxr-xr-x 100 root root 20K Jul 7 01:37 .. -rw-r--r-- 1 root root 3.7K Jul 7 2020 1_harbor.devopsman.cn_bundle.crt -rw-r--r-- 1 root root 1.7K Jul 7 2020 2_harbor.devopsman.cn.key # é‡å‘½åä¹‹åæ”¾åœ¨/data/certç›®å½•ä¸‹ï¼Œå¦‚æœæ²¡æœ‰è¿™ä¸ªç›®å½•ï¼Œéœ€è¦æå‰åˆ›å»º mkdir -pv /data/cert root@master:~/harbor/Nginx# cp 1_harbor.devopsman.cn_bundle.crt /data/cert/harbor.devopsman.cn.crt root@master:~/harbor/Nginx# cp 2_harbor.devopsman.cn.key /data/cert/harbor.devopsman.cn.key   ç„¶ååœ¨ harbor.yml ä¸‹é…ç½®è¯ä¹¦çš„ä½ç½®å³å¯:\n1 2 3 4 5 6 7  # https related config https: # https port for harbor, default is 443 port: 443 # The path of cert and key files for nginx certificate: /data/cert/harbor.devopsman.cn.crt private_key: /data/cert/harbor.devopsman.cn.key   é…ç½®å®Œè¯ä¹¦ï¼Œä½¿ç”¨ prepare è¿›è¡Œé…ç½® nginx çš„ https è¯ä¹¦\n1 2 3 4 5 6  cd /root/harbor # harborç¦»çº¿ç‰ˆè§£å‹åçš„æ–‡ä»¶ç›®å½• root@master:~/harbor# ./prepare prepare base dir is set to /root/harbor ... Generated configuration file: /compose_location/docker-compose.yml Clean up the input dir   æ— æœæ²¡æœ‰æŠ¥é”™ï¼Œç„¶åæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ docker-compose è¿è¡Œ harbor çš„å®¹å™¨äº†\n1 2 3 4 5 6 7 8 9 10 11  root@master:~/harbor# docker-compose up -d Creating network \u0026#34;harbor_harbor\u0026#34; with the default driver Creating harbor-log ... done Creating harbor-portal ... done Creating registry ... done Creating registryctl ... done Creating harbor-db ... done Creating redis ... done Creating harbor-core ... done Creating nginx ... done Creating harbor-jobservice ... done   å®‰è£…æ£€æµ‹ ç„¶åæˆ‘ä»¬å¯ä»¥ç›´æ¥é€šè¿‡ docker login æµ‹è¯•ä¸€ä¸‹\n1 2 3 4 5 6 7 8  root@master:~/harbor# docker login harbor.devopsman.cn Username: admin Password: # é»˜è®¤çš„å¯†ç åœ¨harbor.ymlæ–‡ä»¶ä¸­ï¼Œå¯ä»¥è‡ªè¡Œä¿®æ”¹ WARNING! Your password will be stored unencrypted in /root/.docker/config.json. Configure a credential helper to remove this warning. See https://docs.docker.com/engine/reference/commandline/login/#credentials-store Login Succeeded   é€šè¿‡æµè§ˆå™¨æŸ¥çœ‹æ˜¯å¦èƒ½ç™»å½•ä»¥åŠè¯ä¹¦çš„æœ‰æ•ˆæœŸ\næ­¤æ—¶æˆ‘ä»¬å¯ä»¥é€šè¿‡æ¨é€ä¸€ä¸ªæµ‹è¯•çš„é•œåƒï¼Œæ£€æŸ¥æ˜¯å¤Ÿæ­£å¸¸ï¼Œæˆ‘ä»¬å…ˆåœ¨æµè§ˆå™¨ä¸­è®¿é—® harbor.devopsman.cnï¼Œç„¶åæ‰¾åˆ°æ¨é€å‘½ä»¤ï¼ŒæŸ¥çœ‹æ¨é€çš„æ ¼å¼ï¼Œä¸‹é¢æˆ‘ä»¬æµ‹è¯•ä¸€ä¸‹çœ‹çœ‹ç»“æœï¼š\næˆ‘ä»¬é€‰æ‹©ä¸€ä¸ª k8s é›†ç¾¤æœåŠ¡åŸºç¡€ç»„ä»¶kube-proxyçš„é•œåƒï¼Œé‡æ–°æ‰“ä¸ªé•œåƒçš„ tagï¼Œç„¶åæ¨é€åˆ°æˆ‘ä»¬çš„devopsmanä»“åº“å†…:\n1 2 3 4 5 6 7 8 9 10 11  root@master:~/harbor# docker tag k8s.gcr.io/kube-proxy:v1.18.0 harbor.devopsman.cn/devopsman/kube-proxy:v1.18.0 root@master:~/harbor# docker push harbor.devopsman.cn/devopsman/kube-proxy:v1.18.0 The push refers to repository [harbor.devopsman.cn/devopsman/kube-proxy] 46b37415a80a: Pushed 0d8d54147a3a: Pushed 597151d24476: Pushed ad9fb2411669: Pushed 2dc2f2423ad1: Pushed 682fbb19de80: Pushed fc4976bd934b: Pushed v1.18.0: digest: sha256:b832454a96a848ad5c51ad8a499ef2173b627ded2c225e3a6be5aad9446cb211 size: 1786   é€šè¿‡æŸ¥çœ‹ï¼Œç¡®å®æˆåŠŸçš„å®Œæˆäº†é•œåƒçš„ä¸Šä¼ :\nè¿™æ ·å°±å®Œæˆäº† harbor ç¯å¢ƒçš„åŸºç¡€æ­å»ºï¼Œæ¥ä¸‹æ¥å°±å¥½å¥½çš„ä½“éªŒ Harbor å¸¦æ¥çš„æ–°åŠŸèƒ½å§ï¼Œé€šè¿‡å›¾ä¸Šçœ‹åˆ° harbor2.0 ç›®å‰æ”¯æŒDarkä¸»é¢˜ï¼Œhelm æ¨é€ç­‰ï¼Œå¼€å§‹åŠ¨æ‰‹å§ï¼Œä½“éªŒ Harbor çš„æ–°åŠŸèƒ½å’Œç‰¹æ€§ï¼Œæœ¬ç« èŠ‚å°±å®Œæˆäº† harbor çš„åŸºç¡€æ¢ç´¢ã€‚\n","description":"Harboræ˜¯ä¸€ä¸ªå¼€æºçš„ç®¡ç† Docker é•œåƒä»¥åŠ Helm å›¾è¡¨çš„é¡¹ç›®","id":2,"section":"posts","tags":["Harbor","é•œåƒä»“åº“","HTTPS","é«˜å¯ç”¨"],"title":"Harbor2.0 å®‰è£…éƒ¨ç½²å®è·µ(HTTPS)","uri":"https://linuxermaster.github.io/en/posts/20200707-harbor2.0%E5%B8%A6https%E7%9A%84%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2%E5%AE%9E%E8%B7%B5/"},{"content":"harbor æä¾›äº† harbor ä¸é harbor æœåŠ¡ä¹‹é—´çš„é•œåƒå¤åˆ¶åŠŸèƒ½ï¼Œé€šè¿‡å¤åˆ¶é•œåƒåŠŸèƒ½å¯ä»¥å°† DockerHub ä¸Šçš„ç§æœ‰é•œåƒç»™æ‰¹é‡çš„åŒæ­¥åˆ°æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åœ¨å¤š Harbor å®ä¾‹ä¹‹é—´è¿›è¡ŒåŒæ­¥ï¼Œè¾¾åˆ°é•œåƒå¤šå‰¯æœ¬ï¼Œæ•°æ®é«˜å¯ç”¨çš„ä½œç”¨ã€‚\nReplication Adapters harbor æä¾›äº† harbor ä¸é harbor æœåŠ¡ä¹‹é—´çš„é•œåƒå¤åˆ¶åŠŸèƒ½ï¼Œé€šè¿‡å¤åˆ¶é•œåƒåŠŸèƒ½å¯ä»¥å°† DockerHub ä¸Šçš„ç§æœ‰é•œåƒç»™æ‰¹é‡çš„åŒæ­¥åˆ°æœ¬åœ°ï¼Œä¹Ÿå¯ä»¥é€šè¿‡åœ¨å¤š Harbor å®ä¾‹ä¹‹é—´è¿›è¡ŒåŒæ­¥ï¼Œè¾¾åˆ°é•œåƒå¤šå‰¯æœ¬ï¼Œæ•°æ®é«˜å¯ç”¨çš„ä½œç”¨ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒHarbor æ”¯æŒä¸ harborã€query.ioã€Docker-hub ç­‰çŸ¥åçš„é•œåƒä»“åº“ä¹‹é—´åŒæ­¥ï¼Œè¿˜æ”¯æŒ helm-hub ç­‰ helm å›¾è¡¨ä¹‹é—´çš„åŒæ­¥ï¼š\nä¸‹é¢æˆ‘ä»¬é€šè¿‡ harbor ä¸ harbor å®ä¾‹ä¹‹é—´åŒæ­¥ï¼Œçœ‹ä¸€ä¸‹ Harbor çš„é•œåƒå¤åˆ¶åŠŸèƒ½\nHarbor To Harbor åŸºäºä¸ŠèŠ‚Harbor å¼€æºé•œåƒä»“åº“ä¼ä¸šçº§å®è·µï¼Œå®‰è£…äº†åŸŸåä¸ºharbor.devopsman.cnçš„ harbor å®ä¾‹ï¼Œæ ¹æ®åŒæ ·çš„æ–¹å¼å®‰è£…ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œå¹¶ä¸”é…ç½®å®ƒçš„åŸŸåä¸ºharbor.kubemaster.topï¼Œæˆ‘ä»¬æŠŠä¸Šä¸€èŠ‚ä¸­æ¨é€åˆ° harbor.devopsman.cn çš„é•œåƒ devopsman/kube-proxy:v1.18.0 é•œåƒåŒæ­¥åˆ° harbor.kubemaster.topï¼Œåœ¨å‡†å¤‡å¥½è¿™äº›ç¯å¢ƒä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹é…ç½®é•œåƒä¹‹é—´çš„åŒæ­¥ã€‚\né¦–å…ˆåœ¨ harbor.kubemaster.top ä¸­æ–°å¢ä¸€ä¸ªä»“åº“ç›®æ ‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œé…ç½®å¥½ç›®å‰é•œåƒä»“åº“çš„åœ°å€ã€ç”¨æˆ·åå’Œå¯†ç ä¹‹åï¼Œç‚¹å‡»æµ‹è¯•ä¿å­˜\nç„¶å ï¼Œåœ¨ç³»ç»Ÿç®¡ç†ä¸‹é¢çš„å¤åˆ¶ç®¡ç†å¤„ï¼Œæ–°å¢åŠ ä¸€ä¸ªå¤åˆ¶ç­–ç•¥ï¼Œå¦‚ä¸‹å›¾:\nåœ¨æºé•œåƒä»“åº“å¤„é€‰æ‹©æˆ‘ä»¬ä¹‹å‰åœ¨ä»“åº“ç®¡ç†å¤„é…ç½®å¥½çš„ harbor å®ä¾‹ï¼Œç„¶åé…ç½®æºèµ„æºè¿‡æ»¤ä¿¡æ¯ï¼Œå…¶ä¸­çš„åŒ¹é…ä¿¡æ¯å¦‚ä¸‹ï¼Œå…¶ä¸­(Y)è¡¨ç¤ºåˆæ³•ï¼Œ(N)è¡¨ç¤ºä¸åˆæ³•\n   Pattern String(Match or not)     library/* library/hello-world(Y) library/my/hello-world(N)   library/** library/hello-world(Y) library/my/hello-world(Y)   {library,goharbor}/** library/hello-world(Y) goharbor/harbor-core(Y) google/hello-world(N)   1.? 1.0(Y) 1.01(N)    ç„¶åå¡«å†™è‡ªå®šä¹‰çš„è¿‡æ»¤å™¨è§„åˆ™ä¹‹åï¼Œä¿å­˜ã€‚ç„¶ååœ¨å¤åˆ¶ç®¡ç†åŠŸèƒ½å¤„ï¼Œæ‰¾åˆ°å¹¶é€‰æ‹©åˆšæ‰æ–°å»ºçš„å¤åˆ¶è§„åˆ™ï¼Œç‚¹å‡»å¤åˆ¶ï¼š\nè¿™æ ·å°±æ‰‹åŠ¨çš„è§¦å‘äº†å¤åˆ¶ï¼Œå…¶çŠ¶æ€ä¸ºInProgressï¼Œæˆ‘ä»¬ç‚¹å‡»å¯¹åº”çš„ä»»åŠ¡ IDï¼Œå°±èƒ½çœ‹åˆ°æ›´å¤šçš„å¤åˆ¶ä¿¡æ¯ï¼Œæ¯”å¦‚æˆåŠŸçŠ¶æ€ä¿¡æ¯ï¼ŒåŒæ­¥çš„æ—¥å¿—ä¿¡æ¯ç­‰\nè¿™æ ·ç›®æ ‡ç§æœ‰é•œåƒä»“åº“ä¸­çš„é•œåƒå°±è¢«åŒæ­¥äº†è¿‡æ¥ï¼ŒåŒæ—¶ harbor ä¹Ÿæ”¯æŒå®šæ—¶ä»»åŠ¡åŒæ­¥ï¼Œå…¶æ ¹æ® cron çš„è¯­æ³•è§„åˆ™å®ç°ç§æœ‰é•œåƒä»“åº“ä¹‹é—´çš„é•œåƒçš„è‡ªåŠ¨åŒæ­¥ã€‚\nHarbor é«˜å¯ç”¨ å¦‚æœæƒ³è¦ä¿è¯ harbor å®ä¾‹æ•°æ®çš„é«˜å¯ç”¨ï¼Œå¯ä»¥é€šè¿‡å¤åˆ¶ç®¡ç†çš„åŠŸèƒ½åœ¨å¤šä¸ª harbor ä¹‹é—´äº’ç›¸é…ç½®åŒæ­¥ç­–ç•¥ï¼Œå¯ä»¥åŸºäºpush modeå®ç°ä»»æ„ä¸€ä¸ªå®ä¾‹ä¸Šé¢æ¨é€äº†é•œåƒï¼Œéƒ½ä¼šè¢«è‡ªåŠ¨çš„åŒæ­¥åˆ°å…¶ä»–çš„å®ä¾‹ä¸Šå»ï¼Œç»“åˆ cron çš„å®šæ—¶ä»»åŠ¡åŸºæœ¬ä¸Šå°±è‡ªå®ç°äº† harbor çš„æ•°æ®é«˜å¯ç”¨ï¼Œé¿å…å› å•å®ä¾‹é€ æˆæ•°æ®æ— æ³•æŒ½å›ã€‚\nç²¾å½©æ–‡ç« å›é¡¾  Harbor å¼€æºé•œåƒä»“åº“ä¼ä¸šçº§å®ç° é˜¿é‡Œäº‘å‡ºå“Â·Kubernetes æ·±å…¥æµ…å‡ºå®è·µ v1.0 å¾®è½¯å‡ºå“Â·Kubernetes æœ€æ–°å­¦ä¹ æŒ‡å— v3.0 ç«ç„°å›¾ï¼šå…¨å±€è§†é‡çš„ Linux æ€§èƒ½å‰–æ 1k+åœ¨è¯» æœ€æµè¡Œçš„äº”æ¬¾ Kubernetes äº¤äº’å¼å¯è§†åŒ–å·¥å…· 900+åœ¨è¯» è½»æ¾çˆ¬å–æ‹‰å‹¾ç½‘å²—ä½æ‹›è˜ä¿¡æ¯ 600+åœ¨è¯» Yearning - æœ€ Popular çš„ MYSQL å®¡è®¡å¹³å° 700+åœ¨è¯» Prometheus ç›‘æ§ç³»åˆ—-éƒ¨ç½²ç¯‡ 500+åœ¨è¯» ","description":"harboræä¾›äº†harborä¸éharboræœåŠ¡ä¹‹é—´çš„é•œåƒå¤åˆ¶åŠŸèƒ½ï¼Œè¾¾åˆ°é•œåƒå¤šå‰¯æœ¬ï¼Œæ•°æ®é«˜å¯ç”¨çš„ä½œç”¨ã€‚","id":3,"section":"posts","tags":["Harbor","é•œåƒä»“åº“","Docker","é«˜å¯ç”¨"],"title":"Harbor2.0 å¤šå®ä¾‹ä¹‹é—´é•œåƒå¤åˆ¶","uri":"https://linuxermaster.github.io/en/posts/20200708-harbor2.0-%E5%A4%9A%E5%AE%9E%E4%BE%8B%E4%B9%8B%E9%97%B4%E9%95%9C%E5%83%8F%E5%A4%8D%E5%88%B6/"},{"content":"æ–‡ç« èƒŒæ™¯ æ—¥å¸¸çš„å·¥ä½œä¸­ï¼Œä¼šæ”¶åˆ°ä¸€å †CPUä½¿ç”¨ç‡è¿‡é«˜çš„å‘Šè­¦é‚®ä»¶ï¼Œé‡åˆ°æŸå°æœåŠ¡çš„CPUè¢«å æ»¡äº†ï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±è¦å»æŸ¥çœ‹æ˜¯ä»€ä¹ˆè¿›ç¨‹å°†æœåŠ¡å™¨çš„CPUèµ„æºå ç”¨æ»¡äº†ã€‚é€šå¸¸æˆ‘ä»¬ä¼šé€šè¿‡topæˆ–è€…htopæ¥å¿«é€Ÿçš„æŸ¥çœ‹å æ®CPUæœ€é«˜çš„é‚£ä¸ªè¿›ç¨‹ï¼Œå¦‚ä¸‹å›¾ï¼š\nè¿™é‡Œæ˜¯é€šè¿‡ä¸€ä¸ªæ™®é€šçš„æœåŠ¡å™¨åšæ¼”ç¤ºä½¿ç”¨ï¼Œå¦‚å›¾æ‰€ç¤ºå½“å‰æœåŠ¡å™¨å ç”¨CPUæœ€é«˜çš„æ˜¯ä¸€ä¸ªå«åškube-apiserverå‘½ä»¤è¿è¡Œçš„ä¸€ä¸ªè¿›ç¨‹ï¼Œè¯¥è¿›ç¨‹çš„PIDä¸º25633,å½“ç„¶ä½ å¯èƒ½é‡åˆ°ä¸€ä¸ªæœåŠ¡å™¨ä¸Šè¿è¡Œæœ‰å¤šä¸ªæœåŠ¡ï¼Œæƒ³å¿«é€ŸçŸ¥é“å ç”¨ç‡æœ€é«˜çš„é‚£å‡ ä¸ªè¿›ç¨‹çš„è¯ï¼Œä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤:\n1 2  ps aux|head -1;ps -aux | sort -k3nr | head -n 10 //æŸ¥çœ‹å‰10ä¸ªæœ€å ç”¨CPUçš„è¿›ç¨‹ ps aux|head -1;ps -aux | sort -k4nr | head -n 10 //æŸ¥çœ‹å‰10ä¸ªæœ€å ç”¨å†…å­˜çš„è¿›ç¨‹   ä½†æ˜¯é€šè¿‡ä»¥ä¸Šçš„æ–¹æ³•è·å–åˆ°æœåŠ¡å™¨å ç”¨èµ„æºçš„è¿›ç¨‹ä¹‹åï¼Œè¿˜æ˜¯ä¸çŸ¥é“CPUä½¿ç”¨ç©¶ç«Ÿè€—æ—¶åœ¨å“ªé‡Œ,ä¸æ¸…æ¥šç“¶é¢ˆåœ¨å“ªé‡Œï¼Œæ­¤æ—¶å°±å¯ä»¥é€šè¿‡Linuxç³»ç»Ÿçš„æ€§èƒ½åˆ†æå·¥å…·perfåˆ†æï¼Œåˆ†æå…¶è¿”å›çš„æ­£åœ¨æ¶ˆè€—CPUçš„å‡½æ•°ä»¥åŠè°ƒç”¨æ ˆã€‚ç„¶åå¯ä»¥é€šè¿‡è§£æperfé‡‡é›†çš„æ•°æ®ï¼Œæ¸²æŸ“åˆ°ç«ç„°å›¾ğŸ”¥ï¼Œå°±æ¸…æ¥šçš„çŸ¥é“ç©¶ç«Ÿå ç”¨ç³»ç»ŸCPUèµ„æºçš„ç½ªé­ç¥¸é¦–äº†ã€‚\nåœ¨åˆ¶ä½œç«ç„°å›¾ä¹‹å‰ï¼Œéœ€è¦å…ˆæ¥è¯´è¯´è¿™ä¸ªLinuxæ€§èƒ½åˆ†æå·¥å…·perf,è¯¥å·¥å…·æ˜¯ä¸€ä¸ªç›¸å¯¹ç®€å•æ˜“ä¸Šæ‰‹çš„æ€§èƒ½åˆ†æå·¥å…·ï¼Œæ˜¯Performanceå•è¯çš„ç¼©å†™ï¼Œé€šè¿‡å…¶perfçš„å‘½ä»¤é€‰é¡¹å®Œæˆç³»ç»Ÿäº‹ä»¶çš„é‡‡é›†åˆ°è§£æï¼Œæˆ‘ä»¬æ¥ç®€å•çš„è®¤è¯†ä¸€ä¸‹ï¼š\nlinuxä¸Šçš„æ€§èƒ½åˆ†æå·¥å…·Perf å®‰è£…perf æˆ‘ç›®å‰çš„æœåŠ¡å™¨å‘è¡Œç‰ˆæ˜¯Ubuntu 16.04.6 LTSå› æ­¤éœ€è¦å…ˆå®‰è£…perfæ‰èƒ½ä½¿ç”¨ï¼Œè¯¥å·¥å…·ç”±linux-tools-commonæä¾›ï¼Œä½†æ˜¯å®ƒéœ€è¦å®‰è£…åé¢çš„ä¾èµ–ã€‚\n1 2 3 4 5  #å®‰è£… root@master:~# apt install linux-tools-common linux-tools-4.4.0-142-generic linux-cloud-tools-4.4.0-142-generic -y root@master:~# perf -v #æ˜¾ç¤ºperfçš„ç‰ˆæœ¬ perf version 4.4.167   åœ¨å®‰è£…å®Œæˆæ—¶å€™ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¯¹ä¸Šå›¾CPUä½¿ç”¨ç‡æœ€é«˜çš„è¿›ç¨‹IDä¸º25633çš„è¿›ç¨‹è¿›è¡Œé‡‡æ ·åˆ†æã€‚\né¦–é€‰æˆ‘ä»¬é‡‡é›†ä¸€ä¸‹è¯¥è¿›ç¨‹çš„è°ƒç”¨æ ˆä¿¡æ¯:\n1 2 3  root@master:~# sudo perf record -F 99 -p 25633 -g -- sleep 30 [ perf record: Woken up 1 times to write data ] [ perf record: Captured and wrote 0.039 MB perf.data (120 samples) ]   è¿™ä¸ªå‘½ä»¤ä¼šäº§ç”Ÿä¸€ä¸ªå¤§çš„æ•°æ®æ–‡ä»¶ï¼Œå–å†³ä¸ä½ é‡‡é›†çš„è¿›ç¨‹ä¸CPUçš„é…ç½®ï¼Œå¦‚æœä¸€å°æœåŠ¡å™¨æœ‰16ä¸ª CPUï¼Œæ¯ç§’æŠ½æ ·99æ¬¡ï¼ŒæŒç»­30ç§’ï¼Œå°±å¾—åˆ° 47,520 ä¸ªè°ƒç”¨æ ˆï¼Œé•¿è¾¾å‡ åä¸‡ç”šè‡³ä¸Šç™¾ä¸‡è¡Œã€‚ä¸Šé¢çš„å‘½ä»¤ä¸­ï¼Œperf recordè¡¨ç¤ºè®°å½•ï¼Œ-F 99è¡¨ç¤ºæ¯ç§’99æ¬¡ï¼Œ-p 25633æ˜¯è¿›ç¨‹å·ï¼Œå³å¯¹å“ªä¸ªè¿›ç¨‹è¿›è¡Œåˆ†æï¼Œ-gè¡¨ç¤ºè®°å½•è°ƒç”¨æ ˆï¼Œsleep 30åˆ™æ˜¯æŒç»­30ç§’ï¼Œå‚æ•°ä¿¡æ¯å¯ä»¥è§†æƒ…å†µè°ƒæ•´ã€‚ç”Ÿæˆçš„æ•°æ®é‡‡é›†æ–‡ä»¶åœ¨å½“å‰ç›®å½•ä¸‹ï¼Œåç§°ä¸ºperf.dataã€‚\nperf recordå‘½ä»¤å¯ä»¥ä»é«˜åˆ°ä½æ’åˆ—ç»Ÿè®¡æ¯ä¸ªè°ƒç”¨æ ˆå‡ºç°çš„ç™¾åˆ†æ¯”ï¼Œæ˜¾ç¤ºç»“æœå¦‚ä¸‹å›¾æ‰€ç¤º:\n1  root@master:~# sudo perf report -n --stdio   è¿™æ ·çš„æ•ˆæœå¯¹ä½¿ç”¨è€…æ¥è¯´è¿˜æ˜¯ä¸é‚£ä¹ˆç›´è§‚æ˜“è¯»ï¼Œè¿™æ—¶å€™ï¼Œç«ç„°ğŸ”¥å›¾ä¹Ÿå°±çœŸæ­£çš„æ´¾ä¸Šç”¨é€”äº†ã€‚\nåˆ¶ä½œç«ç„°ğŸ”¥å›¾ ç«ç„°ğŸ”¥å›¾å¹¶éä¸€å®šå°±æ˜¯ç«ç„°ç³»åˆ—çš„é¢œè‰²ä¸»é¢˜ï¼Œåªæ˜¯é€šè¿‡ğŸ”¥è‰²ç³»æ›´èƒ½è¡¨è¾¾å‡ºå«ä¹‰ã€‚ç«ç„°å›¾å¸¸è§çš„ç±»å‹æœ‰ On-CPU, Off-CPU, è¿˜æœ‰ Memory, Hot/Cold, [Differential](http://www.brendangregg.com/blog/2014-11-09/differential-flame-graphs.html \u0026quot;Differential\u0026quot;) ç­‰ç­‰. on-CPU/off-cpu`çš„åŒºåˆ«å°±æ˜¯ä¸€ä¸ªæ˜¯ç”¨äºCPUæ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œä¸€ä¸ªæ˜¯IOæ˜¯æ€§èƒ½ç“¶é¢ˆï¼Œå½“ä½ ä¸çŸ¥é“å½“å‰çš„æœåŠ¡å™¨çš„æ€§èƒ½ç“¶é¢ˆç©¶ç«Ÿæ˜¯ä»€ä¹ˆçš„æ—¶å€™ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸¤ç§ç±»å‹è¿›è¡Œå¯¹æ¯”ï¼Œé€šè¿‡ä¸¤ç§ç«ç„°å›¾çš„å·®åˆ«æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œå¦‚æœä¸¤å¼ ç«ç„°å›¾é•¿å¾—å·®ä¸å¤š, é‚£ä¹ˆé€šå¸¸è®¤ä¸ºCPUè¢«å…¶å®ƒè¿›ç¨‹æŠ¢å äº†.\nå¦å¤–ä¸€ç§æƒ…å†µå°±æ˜¯å¦‚æœæ— æ³•ç¡®å®šå½“å‰çš„ç³»ç»Ÿç“¶é¢ˆ, å¯ä»¥é€šè¿‡å‹æµ‹å·¥å…·æ¥ç¡®è®¤ : é€šè¿‡å‹æµ‹å·¥å…·çœ‹çœ‹èƒ½å¦è®©CPUä½¿ç”¨ç‡è¶‹äºé¥±å’Œ, å¦‚æœèƒ½é‚£ä¹ˆä½¿ç”¨ On-CPU ç«ç„°å›¾, å¦‚æœä¸ç®¡æ€ä¹ˆå‹, CPU ä½¿ç”¨ç‡å§‹ç»ˆä¸Šä¸æ¥, é‚£ä¹ˆå¤šåŠè¯´æ˜ç¨‹åºè¢« IO æˆ–é”å¡ä½äº†, æ­¤æ—¶é€‚åˆä½¿ç”¨ Off-CPU ç«ç„°å›¾. ä½ å¯ä»¥é€šè¿‡å‹æµ‹å·¥å…·è¿›è¡Œæµ‹è¯•ï¼Œç›®å‰æ¯”è¾ƒå¸¸ç”¨çš„å°±æ˜¯abå’Œwrkï¼Œæˆ‘å»ºè®®å°è¯•ä½¿ç”¨è¯¸å¦‚ wrk ä¹‹ç±»æ›´ç°ä»£çš„å‹æµ‹å·¥å…·.\n å¦‚æœé€‰æ‹© ab çš„è¯, é‚£ä¹ˆåŠ¡å¿…è®°å¾—å¼€å¯ -k é€‰é¡¹, ä»¥é¿å…è€—å°½ç³»ç»Ÿçš„å¯ç”¨ç«¯å£\n Githubä¸Šæœ‰Brendan D. Gregg çš„ Flame Graph å·¥ç¨‹å®ç°äº†ä¸€å¥—ç”Ÿæˆç«ç„°å›¾çš„è„šæœ¬.æˆ‘ä»¬å¯ä»¥ç›´æ¥å…‹éš†ä¸‹æ¥ç›´æ¥ç”¨ã€‚\n1  cd \u0026amp;\u0026amp; git clone https://github.com/brendangregg/FlameGraph.git   ç”Ÿæˆç«ç„°ğŸ”¥å›¾ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½éµå¾ªä»¥ä¸‹æµç¨‹\n æ•è·å †æ ˆ: ä½¿ç”¨perfæ•æ‰è¿›ç¨‹è¿è¡Œå †æ ˆä¿¡æ¯ æŠ˜å å †æ ˆ: å¯¹æŠ“å–çš„ç³»ç»Ÿå’Œç¨‹åºè¿è¡Œæ¯ä¸€æ—¶åˆ»çš„å †æ ˆä¿¡æ¯è¿›è¡Œåˆ†æç»„åˆ, å°†é‡å¤çš„å †æ ˆç´¯è®¡åœ¨ä¸€èµ·, ä»è€Œä½“ç°å‡ºè´Ÿè½½å’Œå…³é”®è·¯å¾„ï¼Œé€šè¿‡stackcollapseè„šæœ¬å®Œæˆ ç”Ÿæˆç«ç„°å›¾ï¼šåˆ†æ stackcollapse è¾“å‡ºçš„å †æ ˆä¿¡æ¯æ¸²æŸ“æˆç«ç„°å›¾  Flame Graphä¸­æä¾›äº†æŠ“å–ä¸åŒä¿¡æ¯çš„è„šæœ¬ï¼Œå¯ä»¥æŒ‰éœ€ä½¿ç”¨ã€‚ä¸‹é¢æˆ‘ä»¬éœ€è¦å¯¹æ•è·åˆ°çš„è¿›ç¨‹å †æ ˆä¿¡æ¯perf.dataè¿›è¡ŒæŠ˜å ï¼Œç”ŸæˆæŠ˜å çš„å †æ ˆä¿¡æ¯:\n1  root@master:~# perf script -i /root/perf.data \u0026amp;\u0026gt; /root/perf.unfold   ç”¨ stackcollapse-perf.pl å°† perf è§£æå‡ºçš„å†…å®¹ perf.unfold ä¸­çš„ç¬¦å·è¿›è¡ŒæŠ˜å \n1 2 3 4 5 6 7  root@master:~/FlameGraph# ls aix-perf.pl docs example-perf.svg pkgsplit-perf.pl stackcollapse-aix.pl stackcollapse-go.pl stackcollapse-ljp.awk stackcollapse-pmc.pl stackcollapse-vsprof.pl test.sh demos example-dtrace-stacks.txt files.pl range-perf.pl stackcollapse-bpftrace.pl stackcollapse-instruments.pl stackcollapse-perf.pl stackcollapse-recursive.pl stackcollapse-vtune.pl dev example-dtrace.svg flamegraph.pl README.md stackcollapse-elfutils.pl stackcollapse-java-exceptions.pl stackcollapse-perf-sched.awk stackcollapse-sample.awk stackcollapse-xdebug.php difffolded.pl example-perf-stacks.txt.gz jmaps record-test.sh stackcollapse-gdb.pl stackcollapse-jstack.pl stackcollapse.pl stackcollapse-stap.pl test root@master:~/FlameGraph# ./stackcollapse-perf.pl /root/perf.unfold \u0026amp;\u0026gt; /root/perf.folded root@master:~/FlameGraph#   æœ€åå°±æ˜¯ç”Ÿæˆç«ç„°ğŸ”¥å›¾äº†\n1  root@master:~/FlameGraph# ./flamegraph.pl /root/perf.folded \u0026gt; /root/perf.svg   å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ç®¡é“ç¬¦|å°†æ•´ä¸ªè¿‡ç¨‹ç®€åŒ–:\n1  cd \u0026amp;\u0026amp; perf script | FlameGraph/stackcollapse-perf.pl | FlameGraph/flamegraph.pl \u0026gt; process.svg   æœ€ååœ¨è°·æ­Œæµè§ˆå™¨ä¸Šæ‰“å¼€è¯¥ç«ç„°å›¾:\nç«ç„°å›¾æ˜¯åŸºäºstackä¿¡æ¯ç”Ÿæˆçš„SVG å›¾ç‰‡, ç”¨æ¥å±•ç¤º CPU çš„è°ƒç”¨æ ˆã€‚\n  y è½´è¡¨ç¤ºè°ƒç”¨æ ˆ, æ¯ä¸€å±‚éƒ½æ˜¯ä¸€ä¸ªå‡½æ•°. è°ƒç”¨æ ˆè¶Šæ·±, ç«ç„°å°±è¶Šé«˜, é¡¶éƒ¨å°±æ˜¯æ­£åœ¨æ‰§è¡Œçš„å‡½æ•°, ä¸‹æ–¹éƒ½æ˜¯å®ƒçš„çˆ¶å‡½æ•°.\n  x è½´è¡¨ç¤ºæŠ½æ ·æ•°, å¦‚æœä¸€ä¸ªå‡½æ•°åœ¨ x è½´å æ®çš„å®½åº¦è¶Šå®½, å°±è¡¨ç¤ºå®ƒè¢«æŠ½åˆ°çš„æ¬¡æ•°å¤š, å³æ‰§è¡Œçš„æ—¶é—´é•¿. æ³¨æ„, x è½´ä¸ä»£è¡¨æ—¶é—´, è€Œæ˜¯æ‰€æœ‰çš„è°ƒç”¨æ ˆåˆå¹¶å, æŒ‰å­—æ¯é¡ºåºæ’åˆ—çš„.\n  ç«ç„°å›¾å°±æ˜¯çœ‹é¡¶å±‚çš„å“ªä¸ªå‡½æ•°å æ®çš„å®½åº¦æœ€å¤§. åªè¦æœ‰\u0026quot;å¹³é¡¶\u0026quot;(plateaus), å°±è¡¨ç¤ºè¯¥å‡½æ•°å¯èƒ½å­˜åœ¨æ€§èƒ½é—®é¢˜ã€‚é¢œè‰²æ²¡æœ‰ç‰¹æ®Šå«ä¹‰, å› ä¸ºç«ç„°å›¾è¡¨ç¤ºçš„æ˜¯ CPU çš„ç¹å¿™ç¨‹åº¦, æ‰€ä»¥ä¸€èˆ¬é€‰æ‹©æš–è‰²è°ƒ.\nå½“è°ƒç”¨æ ˆä¸å®Œæ•´è°ƒç”¨æ ˆè¿‡æ·±æ—¶ï¼ŒæŸäº›ç³»ç»Ÿåªè¿”å›å‰é¢çš„ä¸€éƒ¨åˆ†ï¼ˆæ¯”å¦‚å‰10å±‚ï¼‰;å½“å‡½æ•°åç¼ºå¤±ï¼Œå‡½æ•°æ²¡æœ‰åå­—ï¼Œç¼–è¯‘å™¨åªç”¨å†…å­˜åœ°å€æ¥è¡¨ç¤ºï¼ˆæ¯”å¦‚åŒ¿åå‡½æ•°ï¼‰ï¼Œæ‰€ä»¥ä½¿ç”¨ç«ç„°å›¾ä¹Ÿæ˜¯å­˜åœ¨åˆ†æä¸åˆ°çš„åœ°æ–¹ã€‚ä½ ä¹Ÿå¯ä»¥é€šè¿‡ä»¥ä¸‹è„šæœ¬è¿›è¡Œé‡‡é›†åˆ†æç«ç„°å›¾:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16  :GetherAnalysisData.sh\" data-lang=\":GetherAnalysisData.sh\"if [ $# -ne 1 ];then echo \u0026#34;Usage: $0seconds\u0026#34; exit 1 fi perf record -a -g -o perf.data \u0026amp; PID=`ps aux| grep \u0026#34;perf record\u0026#34;| grep -v grep| awk \u0026#39;{print $2}\u0026#39;` if [ -n \u0026#34;$PID\u0026#34; ]; then sleep $1 kill -s INT $PID fi # wait until perf exite sleep 1 perf script -i perf.data \u0026amp;\u0026gt; perf.unfold perl stackcollapse-perf.pl perf.unfold \u0026amp;\u0026gt; perf.folded perl flamegraph.pl perf.folded \u0026gt;perf.svg   ","description":"ç«ç„°ğŸ”¥å›¾å¹¶éä¸€å®šå°±æ˜¯ç«ç„°ç³»åˆ—çš„é¢œè‰²ä¸»é¢˜ï¼Œåªæ˜¯é€šè¿‡ğŸ”¥è‰²ç³»æ›´èƒ½è¡¨è¾¾å‡ºå«ä¹‰ã€‚","id":4,"section":"posts","tags":["ç«ç„°ğŸ”¥å›¾","Linux","æ€§èƒ½åˆ†æ"],"title":"ğŸ”¥å›¾å…¨å±€è§†é‡çš„Linuxæ€§èƒ½å‰–æ","uri":"https://linuxermaster.github.io/en/posts/20200704-%E5%A6%82%E4%BD%95%E7%A1%AE%E5%AE%9Acpu%E6%B6%88%E8%80%97%E5%9C%A8%E5%93%AA%E4%BA%9B%E5%87%BD%E6%95%B0%E4%B8%8A/"},{"content":"Sample images from Pixabay\n","description":"cartoon gallery","id":5,"section":"gallery","tags":null,"title":"Cartoon","uri":"https://linuxermaster.github.io/en/gallery/cartoon/"},{"content":"Sample images from Pixabay\n","description":"photo gallery","id":6,"section":"gallery","tags":null,"title":"Photo","uri":"https://linuxermaster.github.io/en/gallery/photo/"},{"content":"Written in Go, Hugo is an open source static site generator available under the Apache Licence 2.0. Hugo supports TOML, YAML and JSON data file types, Markdown and HTML content files and uses shortcodes to add rich content. Other notable features are taxonomies, multilingual mode, image processing, custom output formats, HTML/CSS/JS minification and support for Sass SCSS workflows.\nHugo makes use of a variety of open source projects including:\n https://github.com/russross/blackfriday https://github.com/alecthomas/chroma https://github.com/muesli/smartcrop https://github.com/spf13/cobra https://github.com/spf13/viper  Hugo is ideal for blogs, corporate websites, creative portfolios, online magazines, single page applications or even a website with thousands of pages.\nHugo is for people who want to hand code their own website without worrying about setting up complicated runtimes, dependencies and databases.\nWebsites built with Hugo are extremelly fast, secure and can be deployed anywhere including, AWS, GitHub Pages, Heroku, Netlify and any other hosting provider.\nLearn more and contribute on GitHub.\n","description":"Hugo, the worldâ€™s fastest framework for building websites","id":11,"section":"","tags":null,"title":"About","uri":"https://linuxermaster.github.io/en/about/"}]